---
export interface Props {
  eventId: string;
  eventTitle: string;
  className?: string;
}

const { eventId, eventTitle, className } = Astro.props;
---

<form
  class:list={[className ?? "event-registration__form"]}
  id="registration-hero__form"
>
  <input
    type="hidden"
    name="eventId"
    value={eventId}
  />

  <div class="registration-form__group">
    <label
      class="registration-form__label"
      for="firstname"
    >
      Vorname
    </label>
    <input
      autocomplete="given-name"
      class="registration-form__input"
      id="firstname"
      name="firstname"
      placeholder="Vorname"
      type="text"
      required
      minlength="2"
    />
  </div>

  <div class="registration-form__group">
    <label
      class="registration-form__label"
      for="lastname"
    >
      Nachname
    </label>
    <input
      autocomplete="family-name"
      class="registration-form__input"
      id="lastname"
      name="lastname"
      placeholder="Nachname"
      type="text"
      required
      minlength="2"
    />
  </div>

  <div class="registration-form__group">
    <label
      class="registration-form__label"
      for="email"
    >
      E-Mail
    </label>
    <input
      autocomplete="email"
      class="registration-form__input"
      id="email"
      name="email"
      inputmode="email"
      placeholder="E-Mail"
      type="email"
      required
    />
  </div>

  <div
    class="event-registration__message"
    id="event-message"
    role="alert"
  >
  </div>

  <button
    class="registration-form__submit registration-form__submit--large"
    type="submit"
  >
    Platz reservieren
  </button>

  <p class="event-registration__privacy">
    Nach dem Absenden erhältst du eine Bestätigungsmail mit allen Details.
  </p>
</form>

<div
  class="event-registration__success"
  id="event-success"
  style="display:none"
>
  <div
    class="event-registration__success-icon"
    aria-hidden="true"
  >
    <svg
      fill="none"
      height="96"
      viewBox="0 0 72 72"
      width="96"
      xmlns="http://www.w3.org/2000/svg"
    >
      <circle
        cx="36"
        cy="36"
        fill="#c17b5d"
        r="36"
        opacity="0.16"
      ></circle>
      <path
        d="m22 36.5 8.5 8.5L50 25"
        stroke="#c17b5d"
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="5"
      ></path>
    </svg>
  </div>
  <h3 class="event-registration__success-title">Anmeldung erfolgreich!</h3>
  <p class="event-registration__success-message">
    Deine Anmeldung für <strong>{eventTitle}</strong> wurde erfolgreich übermittelt. Du erhältst in Kürze
    eine Bestätigung per E-Mail.
  </p>
  <button
    class="event-registration__success-back"
    type="button"
    id="event-reset"
  >
    Weitere Anmeldung
  </button>
</div>

<script>
  import PocketBase from "pocketbase";

  const form = document.getElementById("event-registration-form") as HTMLFormElement;
  const message = document.getElementById("event-message");
  const success = document.getElementById("event-success");
  const resetBtn = document.getElementById("event-reset");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (message) message.textContent = "";

    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = submitBtn?.textContent || "";

    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = "Wird gesendet...";
    }

    try {
      const pb = new PocketBase(import.meta.env.PUBLIC_POCKETBASE_URL);
      const firstname = formData.get("firstname") as string;
      const lastname = formData.get("lastname") as string;
      const name = `${firstname} ${lastname}`;

      await pb.collection("event_registrations").create({
        eventId: formData.get("eventId"),
        name: name,
        email: formData.get("email"),
        status: "pending",
      });

      form.style.display = "none";
      if (success) success.style.display = "block";
    } catch (error: any) {
      if (message) {
        message.textContent = error?.message || "Anmeldung fehlgeschlagen";
        message.style.color = "var(--color-error, red)";
      }
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
  });

  resetBtn?.addEventListener("click", () => {
    form.reset();
    form.style.display = "block";
    if (success) success.style.display = "none";
    if (message) message.textContent = "";
  });
</script>
