---
export interface Props {
  privacyHref: string;
  className?: string;
}

const { privacyHref, className } = Astro.props;
---

<div>
  <form
    class:list={[className ?? "flex flex-col gap-4"]}
    id="newsletter-form"
  >
    <div class="relative flex items-stretch">
      <label
        class="sr-only"
        for="email"
        >E-Mail</label
      >
      <input
        autocomplete="email"
        class="flex-1 px-6 py-4 rounded-full bg-[var(--color-white)] dark:bg-[color-mix(in_srgb,#2d2520_100%,transparent)] border-2 border-[color-mix(in_srgb,var(--color-primary)_20%,transparent)] dark:border-[color-mix(in_srgb,var(--color-primary)_30%,transparent)] text-[var(--color-text)] text-base transition-all duration-300 [transition-timing-function:var(--transition-smooth)] focus:outline-none focus:border-[var(--color-primary)] dark:focus:border-[var(--color-primary-light)] focus:shadow-[0_0_0_4px_rgba(193,123,93,0.1)] pr-16"
        id="email"
        name="email"
        inputmode="email"
        placeholder="deine@email.de"
        type="email"
        required
      />
      <button
        aria-label="Newsletter abonnieren"
        class="absolute right-2 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-[var(--gradient-primary)] text-[var(--color-white)] flex items-center justify-center transition-all duration-300 [transition-timing-function:var(--transition-smooth)] hover:shadow-[var(--shadow-colored)] hover:scale-110 active:scale-95 cursor-pointer border-none"
        type="submit"
      >
        <svg
          aria-hidden="true"
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M5 12h14M12 5l7 7-7 7"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
          ></path>
        </svg>
      </button>
    </div>

    <div
      class="text-[var(--color-error)] text-sm"
      id="newsletter-message"
      role="alert"
    >
    </div>

    <p class="text-[var(--color-text-light)] text-sm">
      Mit der Anmeldung akzeptierst du unsere <a href={privacyHref} class="text-[var(--color-primary)] dark:text-[var(--color-primary-light)] underline hover:no-underline">Datenschutzbestimmungen</a>
    </p>
  </form>

  <div
    class="text-center hidden"
    id="newsletter-success"
    style="display:none"
  >
    <div
      class="flex justify-center items-center mb-[var(--spacing-lg)] animate-[success-pulse_0.6s_cubic-bezier(0.23,1,0.32,1)]"
      aria-hidden="true"
    >
      <svg
        fill="none"
        height="96"
        viewBox="0 0 72 72"
        width="96"
        xmlns="http://www.w3.org/2000/svg"
      >
        <circle
          cx="36"
          cy="36"
          fill="#c17b5d"
          r="36"
          opacity="0.16"
        ></circle>
        <path
          d="m22 36.5 8.5 8.5L50 25"
          stroke="#c17b5d"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="5"
        ></path>
      </svg>
    </div>
    <h3 class="text-[var(--color-primary)] dark:text-[var(--color-primary-light)] text-2xl font-bold mb-4">Danke für dein Vertrauen!</h3>
    <p class="text-[var(--color-text)] dark:text-[color-mix(in_srgb,var(--color-white)_90%,transparent)] mb-6">
      Du erhältst ab jetzt Inspirationen, Termine und Neuigkeiten direkt in dein Postfach.
    </p>
    <button
      class="inline-flex items-center gap-2 px-6 py-3 rounded-full border-2 border-[var(--color-primary)] text-[var(--color-primary)] bg-transparent transition-all duration-300 [transition-timing-function:var(--transition-smooth)] hover:bg-[var(--color-primary)] hover:text-[var(--color-white)] hover:-translate-y-0.5 font-semibold cursor-pointer"
      type="button"
      id="newsletter-reset"
    >
      Zurück zum Formular
      <svg
        fill="none"
        height="18"
        viewBox="0 0 24 24"
        width="18"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12 19 5 12l7-7M5 12h14"
          stroke="currentColor"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
        ></path>
      </svg>
    </button>
  </div>
</div>

<style>
  @keyframes success-pulse {
    0% {
      opacity: 0;
      transform: scale(0);
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<script>
  import PocketBase from "pocketbase";

  const form = document.getElementById("newsletter-form") as HTMLFormElement;
  const message = document.getElementById("newsletter-message");
  const success = document.getElementById("newsletter-success");
  const resetBtn = document.getElementById("newsletter-reset");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (message) message.textContent = "";

    const formData = new FormData(form);
    const email = formData.get("email") as string;

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    if (submitBtn) submitBtn.disabled = true;

    try {
      const pb = new PocketBase(import.meta.env.PUBLIC_POCKETBASE_URL);
      await pb.collection("newsletter_subscribers").create({ email });

      form.style.display = "none";
      if (success) success.style.display = "block";
    } catch (error: any) {
      if (message) {
        message.textContent = error?.message || "Anmeldung fehlgeschlagen";
        message.style.color = "var(--color-error, red)";
      }
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  });

  resetBtn?.addEventListener("click", () => {
    form.reset();
    form.style.display = "block";
    if (success) success.style.display = "none";
    if (message) message.textContent = "";
  });
</script>
